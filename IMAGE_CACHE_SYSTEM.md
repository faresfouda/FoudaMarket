# نظام التخزين المؤقت للصور - FoudaMarket

## نظرة عامة
تم إنشاء نظام caching شامل للصور في تطبيق FoudaMarket لتحسين الأداء وتقليل استهلاك البيانات وتوفير تجربة مستخدم أفضل.

## المميزات الرئيسية

### 1. **إدارة ذكية للتخزين**
- **حجم أقصى**: 100 ميجابايت للتخزين المؤقت
- **عمر أقصى**: 7 أيام للملفات المخزنة
- **تنظيف تلقائي**: حذف الملفات القديمة تلقائياً
- **ضغط ذكي**: حذف أقدم الملفات عند تجاوز الحد الأقصى

### 2. **أمان وموثوقية**
- **مفاتيح فريدة**: استخدام SHA-256 لتوليد مفاتيح فريدة للصور
- **تحقق من الصحة**: التحقق من عمر الملفات قبل الاستخدام
- **معالجة الأخطاء**: معالجة شاملة للأخطاء مع رسائل واضحة

### 3. **واجهة إدارة متقدمة**
- **معلومات مفصلة**: عرض حجم التخزين وعدد الملفات
- **شريط التقدم**: عرض نسبة استخدام التخزين
- **أزرار التحكم**: مسح التخزين المؤقت وتحديث المعلومات

## الملفات المحدثة

### 1. `lib/services/image_cache_service.dart`
خدمة التخزين المؤقت الرئيسية مع جميع الوظائف الأساسية.

### 2. `lib/views/admin/widgets/cache_info_widget.dart`
Widget لعرض معلومات التخزين المؤقت وإدارته.

### 3. `lib/views/admin/admin_profile_screen.dart`
إضافة خيار "معلومات التخزين المؤقت" في الملف الشخصي للمدير.

### 4. `pubspec.yaml`
إضافة التبعيات المطلوبة:
- `path_provider: ^2.1.2`
- `crypto: ^3.0.3`

## كيفية الاستخدام

### 1. **تهيئة الخدمة**
```dart
// في main.dart أو عند بدء التطبيق
await ImageCacheService().initialize();
```

### 2. **حفظ صورة في التخزين المؤقت**
```dart
final imageData = await http.get(Uri.parse(imageUrl));
if (imageData.statusCode == 200) {
  final cachePath = await ImageCacheService().cacheImage(
    imageUrl, 
    imageData.bodyBytes
  );
  if (cachePath != null) {
    print('تم حفظ الصورة في: $cachePath');
  }
}
```

### 3. **الحصول على صورة من التخزين المؤقت**
```dart
final cachedFile = await ImageCacheService().getCachedImage(imageUrl);
if (cachedFile != null) {
  // استخدام الصورة المخزنة
  final image = FileImage(cachedFile);
} else {
  // تحميل الصورة من الإنترنت
  // ...
}
```

### 4. **التحقق من وجود صورة في التخزين المؤقت**
```dart
final isCached = await ImageCacheService().isImageCached(imageUrl);
if (isCached) {
  // الصورة موجودة في التخزين المؤقت
} else {
  // تحميل الصورة من الإنترنت
}
```

### 5. **الحصول على معلومات التخزين المؤقت**
```dart
final cacheInfo = await ImageCacheService().getCacheInfo();
print('الحجم المستخدم: ${cacheInfo.totalSizeMB} MB');
print('عدد الملفات: ${cacheInfo.fileCount}');
print('نسبة الاستخدام: ${cacheInfo.usagePercentage}%');
```

### 6. **مسح التخزين المؤقت**
```dart
await ImageCacheService().clearCache();
```

## واجهة الإدارة

### **الوصول إلى معلومات التخزين المؤقت**
1. انتقل إلى **الملف الشخصي للمدير**
2. اضغط على **"معلومات التخزين المؤقت"**
3. ستظهر نافذة تحتوي على:
   - الحجم المستخدم والحد الأقصى
   - شريط التقدم لنسبة الاستخدام
   - عدد الملفات والملفات الصالحة
   - عمر التخزين الأقصى
   - زر مسح التخزين المؤقت

### **معلومات معروضة**
- **الحجم المستخدم**: المساحة المستخدمة بالميجابايت
- **الحد الأقصى**: الحد الأقصى المسموح (100 MB)
- **نسبة الاستخدام**: شريط ملون يوضح نسبة الاستخدام
- **عدد الملفات**: إجمالي عدد الملفات المخزنة
- **الملفات الصالحة**: عدد الملفات التي لم تنتهي صلاحيتها
- **عمر التخزين الأقصى**: 7 أيام

## إعدادات النظام

### **الحدود الافتراضية**
```dart
static const int _maxCacheSize = 100 * 1024 * 1024; // 100 MB
static const int _maxCacheAge = 7 * 24 * 60 * 60 * 1000; // 7 days
```

### **تخصيص الإعدادات**
يمكن تعديل هذه القيم في `ImageCacheService` حسب احتياجات التطبيق:

```dart
// زيادة الحد الأقصى إلى 200 MB
static const int _maxCacheSize = 200 * 1024 * 1024;

// زيادة عمر التخزين إلى 14 يوم
static const int _maxCacheAge = 14 * 24 * 60 * 60 * 1000;
```

## آلية العمل

### 1. **توليد المفاتيح**
```dart
String _generateCacheKey(String url) {
  final bytes = utf8.encode(url);
  final digest = sha256.convert(bytes);
  return digest.toString();
}
```

### 2. **حفظ الملفات**
- إنشاء مفتاح فريد للصورة
- حفظ الصورة في مجلد التخزين المؤقت
- تحديث timestamp للملف
- التحقق من حجم التخزين المؤقت

### 3. **استرجاع الملفات**
- البحث عن الملف باستخدام المفتاح
- التحقق من عمر الملف
- إرجاع الملف إذا كان صالحاً
- حذف الملف إذا انتهت صلاحيته

### 4. **التنظيف التلقائي**
- حذف الملفات التي انتهت صلاحيتها
- حذف أقدم الملفات عند تجاوز الحد الأقصى
- تحديث timestamps

## الفوائد

### 1. **تحسين الأداء**
- **تحميل أسرع**: الصور المخزنة محلياً تتحمل أسرع
- **تقليل استهلاك البيانات**: عدم تحميل الصور المتكررة
- **تجربة مستخدم أفضل**: عرض فوري للصور المخزنة

### 2. **إدارة ذكية للمساحة**
- **تنظيف تلقائي**: حذف الملفات القديمة تلقائياً
- **ضغط ذكي**: إدارة المساحة حسب الأولوية
- **مراقبة الاستخدام**: عرض معلومات مفصلة عن الاستخدام

### 3. **موثوقية عالية**
- **معالجة الأخطاء**: معالجة شاملة للأخطاء
- **استرداد آمن**: استرداد آمن للملفات التالفة
- **أمان البيانات**: استخدام مفاتيح فريدة وآمنة

## استراتيجيات التحسين

### 1. **ضغط الصور**
يمكن إضافة ضغط للصور قبل التخزين:
```dart
import 'package:flutter_image_compress/flutter_image_compress.dart';

Future<Uint8List> compressImage(Uint8List imageData) async {
  return await FlutterImageCompress.compressWithList(
    imageData,
    quality: 85,
  );
}
```

### 2. **تخزين متعدد المستويات**
```dart
// تخزين نسخ مختلفة من الصورة
await cacheImage('${url}_thumb', thumbnailData);
await cacheImage('${url}_medium', mediumData);
await cacheImage('${url}_full', fullData);
```

### 3. **تحميل مسبق**
```dart
// تحميل مسبق للصور المتوقعة
Future<void> preloadImages(List<String> imageUrls) async {
  for (final url in imageUrls) {
    if (!await isImageCached(url)) {
      // تحميل الصورة في الخلفية
      _loadImageInBackground(url);
    }
  }
}
```

## استكشاف الأخطاء

### **مشاكل شائعة وحلولها**

#### 1. **خطأ في الوصول للمجلد**
```dart
// التأكد من وجود المجلد
if (!await _cacheDir!.exists()) {
  await _cacheDir!.create(recursive: true);
}
```

#### 2. **خطأ في حفظ الملف**
```dart
try {
  await file.writeAsBytes(imageData);
} catch (e) {
  debugPrint('Error saving file: $e');
  // حذف الملف التالف
  if (await file.exists()) {
    await file.delete();
  }
}
```

#### 3. **خطأ في قراءة الملف**
```dart
if (await file.exists()) {
  try {
    final size = await file.length();
    if (size > 0) {
      return file;
    }
  } catch (e) {
    // حذف الملف التالف
    await file.delete();
  }
}
```

## المراقبة والتقارير

### **إحصائيات الاستخدام**
```dart
final cacheInfo = await ImageCacheService().getCacheInfo();
print('''
معلومات التخزين المؤقت:
- الحجم المستخدم: ${cacheInfo.totalSizeMB} MB
- عدد الملفات: ${cacheInfo.fileCount}
- الملفات الصالحة: ${cacheInfo.validFiles}
- نسبة الاستخدام: ${cacheInfo.usagePercentage}%
- العمر الأقصى: ${cacheInfo.maxAgeDays} يوم
''');
```

### **تنبيهات النظام**
```dart
if (cacheInfo.usagePercentage > 80) {
  // تنبيه: التخزين المؤقت ممتلئ تقريباً
  _showCacheWarning();
}
```

## التطوير المستقبلي

### 1. **ميزات إضافية**
- **تخزين سحابي**: رفع الصور إلى التخزين السحابي
- **مزامنة متعددة الأجهزة**: مزامنة التخزين المؤقت بين الأجهزة
- **تحليل الاستخدام**: إحصائيات مفصلة عن استخدام الصور

### 2. **تحسينات الأداء**
- **ضغط متقدم**: ضغط ذكي للصور حسب الحجم
- **تحميل تدريجي**: تحميل تدريجي للصور الكبيرة
- **ذاكرة مؤقتة**: تخزين مؤقت في الذاكرة للصور المستخدمة بكثرة

### 3. **ميزات إدارية**
- **إعدادات متقدمة**: تخصيص إعدادات التخزين المؤقت
- **تقارير مفصلة**: تقارير مفصلة عن استخدام التخزين
- **تنبيهات ذكية**: تنبيهات عند الحاجة لتنظيف التخزين

## الخلاصة

نظام التخزين المؤقت للصور في FoudaMarket يوفر:
- **أداء محسن** مع تحميل أسرع للصور
- **إدارة ذكية** للمساحة مع تنظيف تلقائي
- **واجهة إدارية** شاملة لمراقبة الاستخدام
- **موثوقية عالية** مع معالجة شاملة للأخطاء
- **قابلية التوسع** مع إمكانية التخصيص والتطوير

هذا النظام يساهم بشكل كبير في تحسين تجربة المستخدم وتقليل استهلاك البيانات في التطبيق. 🚀 